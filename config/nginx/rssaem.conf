# RSAEM Robot Web Server Configuration
# nginx reverse proxy for unified access on port 80
#
# Services:
#   /           → Static web interface
#   /stream     → web_video_server (camera streaming)
#   /rosbridge  → rosbridge_websocket (WebSocket)
#
# Install: sudo cp rssaem.conf /etc/nginx/sites-available/
#          sudo ln -sf /etc/nginx/sites-available/rssaem.conf /etc/nginx/sites-enabled/
#          sudo rm /etc/nginx/sites-enabled/default
#          sudo systemctl restart nginx

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    # Static web interface files
    # Copied to /var/www/rssaem for nginx access
    root /var/www/rssaem;
    index index.html;

    # Main location - serve static files
    location / {
        try_files $uri $uri/ /index.html;

        # CORS headers for local development
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";
    }

    # Camera streaming proxy to web_video_server
    location /stream {
        proxy_pass http://127.0.0.1:8080/stream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_buffering off;
        proxy_cache off;

        # For MJPEG streaming
        proxy_read_timeout 86400;
        chunked_transfer_encoding off;
    }

    # Snapshot from camera
    location /snapshot {
        proxy_pass http://127.0.0.1:8080/snapshot;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # ROSBridge WebSocket proxy
    location /rosbridge {
        proxy_pass http://127.0.0.1:9090;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400;
    }

    # Direct WebSocket connection (for compatibility)
    location /ws {
        proxy_pass http://127.0.0.1:9090;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }

    # Health check endpoint
    location /health {
        return 200 '{"status": "ok", "server": "rssaem"}';
        add_header Content-Type application/json;
    }

    # Disable access log for streams (reduces I/O)
    access_log off;
    error_log /var/log/nginx/rssaem_error.log warn;
}
